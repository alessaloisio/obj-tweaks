/*!
 * Copyright (c) 2020 Aloisio Alessandro
 * 
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the
 * "Software"), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish,
 * distribute, sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so, subject to
 * the following conditions:
 * 
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self)["obj-kit"]=t()}(this,function(){"use strict";function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,i)}return n}function u(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?i(Object(n),!0).forEach(function(e){c(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function f(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function o(e){if("object"===s(e))for(var t=0;t<Object.keys(e).length;t++){var n=Object.keys(e)[t];e[n]&&"object"===s(e[n])&&o(e[n]);var i=n.indexOf(".");if(0<i){var r=n.substring(0,i);e[r]=u({},e[r],c({},n.substring(i+1),e[n])),delete e[n],--t}}return e}var d=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.obj=e,this.searchState={depth:0,validation:{position:0,status:!1,findPath:[]}},this.updated=!1}var e,n,i;return e=t,(n=[{key:"find",value:function(e){return this.findRecursive(this.obj,o(e))}},{key:"findRecursive",value:function(n,i,e,t){var r=this,o=2<arguments.length&&void 0!==e?e:[],a=3<arguments.length&&void 0!==t?t:u({},this.searchState);return Object.keys(n).map(function(e){if(i[e]&&"$"===i[e][0])switch(i[e]){case"$exist":case"$get":o.push(n[e]),delete i[e]}if(!a.validation.position&&i[e]&&(a.validation.position=a.depth,a.validation.status=!0),n[e]&&"object"===s(n[e])){var t=i[e]?u({},i[e]):u({},i);r.findRecursive(n[e],t,o,u({},a,{depth:a.depth+1,validation:u({},a.validation,{findPath:[].concat(f(a.validation.findPath),[e])})})),a.depth>=a.validation.position&&(Object.keys(t).length||delete i[e])}else n[e]===i[e]&&(a.validation.position||(a.validation.position=a.depth,a.validation.status=!0),delete i[e]);return!0}),a.validation.status&&a.depth===a.validation.position&&(Object.keys(i).length||(n.constructor._v_path=a.validation.findPath,o.push(n)),a.validation.position=0,a.validation.status=!1),o}},{key:"merge",value:function(e){var t=this;return e instanceof Array?e.map(function(e){return t.mergeRecursive(t.obj,o(e))}):this.mergeRecursive(this.obj,o(e))}},{key:"mergeRecursive",value:function(n,i,e){var r=this,o=2<arguments.length&&void 0!==e?e:u({},this.searchState);return Object.keys(n).map(function(t){return n[t]&&"object"===s(n[t])?(i[t]&&(o=u({},o,{validation:u({},o.validation,{position:o.depth,status:!0})})),r.mergeRecursive(n[t],i[t]?i[t]:JSON.parse(JSON.stringify(i)),u({},o,{depth:o.depth+1})),i[t]&&(Object.keys(i[t]).length&&Object.keys(i[t]).map(function(e){return n[t][e]=i[t][e]}),delete i[t]),Object.keys(i).length&&o.depth===o.validation.position&&(!o.validation.status&&r.updated||(Object.keys(i).map(function(e){return n instanceof Array?void 0===n[t][e]&&(n[t][e]=i[e]):void 0===n[e]&&(n[e]=i[e]),!0}),r.updated=!0))):void 0!==i[t]&&(i[t]!==n[t]&&(n[t]=i[t]),delete i[t]),!0}),n}},{key:"add",value:function(e,t){return this.obj.update(function(e,t){return"string"==typeof e&&(e=c({},e,1<arguments.length&&void 0!==t?t:"$exist")),o(e)}(e,"$exist"),t)}},{key:"delete",value:function(e){var r=this;return this.obj.find(e).map(function(e){var t=e.constructor._v_path,n=t.pop(),i=r.goto(t);return i[n]&&delete i[n],c({},n,e)})}},{key:"swap",value:function(e,t){var n=this.delete(e);this.obj.add(t,n)}},{key:"goto",value:function(e,t){var n=1<arguments.length&&void 0!==t?t:this.obj;if(e.length){var i=e.reverse().pop();n[i]&&(n=this.goto(e,n[i]))}return n}}])&&r(e.prototype,n),i&&r(e,i),t}();d.newObj=!1;return["new","update","find","add","merge","exist","delete","swap"].map(function(u){return Object.prototype[u]=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i,r,o,a=("boolean"==typeof t[t.length-1]?t.pop():"new"===u||d.newObj)?JSON.parse(JSON.stringify(this)):this,s=new d(a);switch(u){case"update":i=t[0],r=t[1],s.find(i).merge(r);break;case"add":o=t[0],r=t[1],s.add(o,r);break;case"find":return i=t[0],s.find(i);case"merge":return r=t[0],s.merge(r);case"exist":return r=t[0],!!s.find(c({},r,"$exist")).length;case"delete":i=t[0],s.delete(i);break;case"swap":i=t[0],o=t[1],s.swap(i,o)}return s.obj},!0}),d});